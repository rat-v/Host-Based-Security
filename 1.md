reIn this lab, I am exploiting a Windows Machine with Metasploit by
using a vulnerability found with Nmap. I will then use this knowledge to
harden the system so it doesn't happen.

### **Open Ports**

I am using a Kali Linux system. I can ping the other Windows System in
the network. I also use nmap to scan the system for any open ports.

#### **FTP**

![](output\1/media/image10.png){width="5.442708880139983in"
height="3.4152996500437447in"}

FTP sends data in clear text making it vulnerable, making it a good
target to exploit. Additionally, anonymous users are sometimes allowed
to download and even upload files to a server. If anonymous access is
allowed, then putting "ftp" in the user and any password will be
accepted no matter what. I don't put anything in the password, only
pressing enter, and it still goes through.

![](output\1/media/image18.png){width="6.442708880139983in"
height="2.2889621609798776in"}

Now that I have logged in anonymously, I can view what files I can
download from the server.

**'get flag.txt'** to download the file named flag.txt in plain text as
FTP is not secure.

![](output\1/media/image19.png){width="8.989583333333334in"
height="2.7738681102362204in"}

![](output\1/media/image21.png){width="6.229166666666667in"
height="3.2755872703412074in"}

**'put 8675309.mp3'** to upload the mp3 file to the server. This is a
critical threat allowing people to store files that should not be there.

#### HTTP

In the Nmap scan, the HTTP port was also shown to be open. I can type
'192.168.1.100' in the URL bar of a web browser to see if a website has
been set up for the company. It seems to be the default IIS web page, so
it has not been configured.

![](output\1/media/image16.png){width="7.21875in"
height="4.402767935258093in"}

#### SMB

The Nmap scan also showed port 445 open. I am completely unfamiliar with
SMB, so I am following the lab closely.

**'smb -L 192.168.1.100'** to list the shares on the system

When prompted for the password, I was able to just hit enter and then I
had access.

![](output\1/media/image1.png){width="7.520833333333333in"
height="3.0625in"}

There is a critical 2016 SMB Windows Server vulnerability designated as
MS17-010, this is what will be used to exploit the machine.

### **Exploiting the Machine**

**'msfdb init'** to initialize a metasploit database

**'msfconsole'** to initialize metasploit

**'search MS17-010'** to search for exploits

![](output\1/media/image5.png){width="10.0in"
height="4.111111111111111in"}

\(5\) to select the ms17_010_psexec exploit

With this exploit selected, I can type **'info'** to get relevant
information on the exploit, especially finding references on the exploit
which can then help me secure this system from the exploit later on.

![](output\1/media/image13.png){width="10.0in"
height="2.1805555555555554in"}

Back to exploiting the machine, after setting the remote host 'RHOSTS'
to the target IP, I can use **'check'** to tell metasploit to see if the
system is vulnerable to the exploit

![](output\1/media/image11.png){width="10.0in"
height="1.2777777777777777in"}

It seems I don't need to set 'LHOST' so I can just 'exploit'. A
meterpreter shell opens up.

![](output\1/media/image23.png){width="10.0in"
height="2.736111111111111in"}

'shell' to enter the Windows command prompt of the system. This could be
more useful to those who are more comfortable working in command prompt
as the commands differ from meterpreter and cmd. There may also be
additional functionality, but I don\'t even know the full scope of
meterpreter yet

WIthin command prompt, I can create a new user and escalate that user to
have admin permissions

\`net user hacker P@ssw0rd /add\`

\`net localgroup administrators hacker /add\`

![](output\1/media/image22.png){width="7.020833333333333in"
height="3.3541666666666665in"}

### **Hardening the Machine**

Now working on the Windows machine that was just attacked.

When logging in, a "Server Manager" window opened up.

#### FTP and HTTP

Manage â†’ Remove Roles and
Features![](output\1/media/image9.png){width="10.0in"
height="2.4445220909886265in"}

In this menu, I can see all the roles that are enabled

![](output\1/media/image17.png){width="6.302083333333333in"
height="4.125in"}

From here, I can remove all the roles related to the Web Server. The
website is not configured at all and it seems to not be needed as it was
not being used. This also removes the FTP server from being active,
removing that vulnerability. After that, I restarted the computer.

![](output\1/media/image6.png){width="4.083333333333333in"
height="1.9791666666666667in"}

Now, when going back to the Kali machine and scanning the Windows
machine with Nmap, the HTTP and FTP ports are no longer showing up as
open.

![](output\1/media/image8.png){width="6.604166666666667in"
height="2.6354166666666665in"}

The SMB vulnerability is still up, at this point, so now I will secure
the system from that.

#### SMB

Going back to the Windows machine, the guest user for the system is
active which is allowing attackers to browse shares on the machine, as
well as allowing the MS17-010 exploit to work.

![](output\1/media/image7.png){width="10.0in"
height="2.4583333333333335in"}

**'net user guest /active:no'** to disable the guest account

![](output\1/media/image15.png){width="10.0in"
height="2.7916666666666665in"}

Now back on the Kali machine, I can no longer enumerate the shares on
the system as I can't get access without the correct password.

![](output\1/media/image12.png){width="4.760416666666667in"
height="0.7395833333333334in"}

Additionally, I run into problems when I attempt to exploit the machine
again in the metasploit console.

**'check'** to see the vulnerability of the machine to the exploit shows
an error due to "an SMB Login Error"

![](output\1/media/image2.png){width="9.0in" height="1.4375in"}

**'exploit'** to run the exploit, I can no longer create a session with
the machine

![](output\1/media/image20.png){width="10.0in"
height="0.9166666666666666in"}

I find it amazing how something as simple as disabling the guest account
can completely prevent this attack.

#### Cleaning Up

Now that the vulnerability is closed, I can clean up the damage done by
the Kali machine

On the Windows machine, I can view users with administrator permissions

**'net localgroup administrators'** to view users in the administrator
group

![](output\1/media/image4.png){width="10.0in"
height="2.0972222222222223in"}

I see that there is an unauthorized user with administrator permissions,
so I can disable the account

**'net user hacker /active:no'** to disable the user named hacker

![](output\1/media/image14.png){width="7.4375in"
height="3.4479166666666665in"}

Now I can remove the account entirely from the system

'**net user hacker /delete'** to delete the user named hacker

![](output\1/media/image3.png){width="10.0in"
height="3.7083333333333335in"}

### Skills 

Windows Hardening

Nmap

Metasploit

Windows

Command Prompt

Kali Linux

Linux Terminal

Meterpreter

### What to Learn More About (just notes for me)

What SMB is, what are shares, why are they significant

Different services

Famous exploits
